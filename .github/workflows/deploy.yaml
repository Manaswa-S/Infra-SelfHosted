name: Validate & Copy

on:
  push:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Install Docker
        run: |
          set -e
          
          echo ">$> Removing older docker versions"
          sudo apt-get remove -y docker docker-engine docker.io containerd runc || true
      
          echo ">$> Installing docker ..."
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            curl \
            gnupg
      
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
            sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          sudo chmod a+r /etc/apt/keyrings/docker.gpg
      
          echo \
            "deb [arch=$(dpkg --print-architecture) \
            signed-by=/etc/apt/keyrings/docker.gpg] \
            https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      
          sudo apt-get update
      
          sudo apt-get install -y \
            docker-ce \
            docker-ce-cli \
            containerd.io \
            docker-buildx-plugin \
            docker-compose-plugin
      
          docker compose version

      - name: Verify Docker
        run: |
          set -e
      
          echo ">$> Checking Docker binary..."
          docker --version
      
          echo ">$> Checking Docker daemon..."
          docker info >/dev/null
      
          echo ">$> Checking Docker Compose plugin..."
          docker compose version
      
          echo ">$> Docker is installed, running, and usable."

      - name: Validate docker-compose files
        run: |
          set -e
          echo ">$> Validating docker-compose files..."
          for file in $(find . -name "docker-compose*.yaml"); do
            echo ">$> Checking $file"
            docker compose -f "$file" config >/dev/null
          done
          echo ">$> All docker-compose files are valid."
        
  sync:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_SSH_HOST_IP }} >> ~/.ssh/known_hosts

      - name: Sync infra to EC2
        run: |
          rsync -avz \
            --exclude ".git" \
            infra/ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_SSH_HOST_IP }}:${{ secrets.EC2_TARGET_DIR }}/

      - name: Verify files on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_SSH_HOST_IP }} \
            "ls -lRa ${{ secrets.EC2_TARGET_DIR }}"
